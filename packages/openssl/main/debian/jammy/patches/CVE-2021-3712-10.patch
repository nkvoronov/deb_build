From d041d377e732504310ea4f8928e99b427914321f Mon Sep 17 00:00:00 2001
From: Matt Caswell <matt@openssl.org>
Date: Thu, 19 Aug 2021 15:25:04 +0100
Subject: [PATCH] Allow fuzz builds to detect string overruns

If FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION is defined then we don't NUL
terminate ASN1_STRING datatypes. This shouldn't be necessary but we add it
any for safety in normal builds.
---
 crypto/asn1/asn1_lib.c | 9 +++++++++
 1 file changed, 9 insertions(+)

--- a/crypto/asn1/asn1_lib.c
+++ b/crypto/asn1/asn1_lib.c
@@ -292,7 +292,16 @@ int ASN1_STRING_set(ASN1_STRING *str, co
     if (data != NULL) {
         memcpy(str->data, data, len);
         /* an allowance for strings :-) */
+#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION
+        /*
+         * Arbitrary byte on the end, which should never be read if the string
+         * length is being properly respected.
+         */
+        str->data[len] = 'x';
+#else
+        /* This should not be necessary - but we add it as a safety precaution */
         str->data[len] = '\0';
+#endif
     }
     return 1;
 }
